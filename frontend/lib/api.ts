import axios from 'axios';

const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';

const api = axios.create({
  baseURL: API_BASE_URL,
  headers: {
    'Content-Type': 'application/json',
  },
});

// Add response interceptor for better error handling
api.interceptors.response.use(
  response => response,
  error => {
    console.error('API Error Details:', {
      message: error.message,
      code: error.code,
      baseURL: error.config?.baseURL,
      url: error.config?.url,
      status: error.response?.status,
      data: error.response?.data,
    });
    return Promise.reject(error);
  }
);

// Types
export interface ChatResponse {
  response: string;
  sources: string[];
}

export interface UserProfile {
  age?: number;
  gender?: string;
  income: string;
  employmentStatus: string;
  taxRegime: string;
  homeownerStatus: string;
  children?: string;
  childrenAges?: string;
  parentsAge?: string;
  investmentCapacity?: string;
  riskAppetite?: string;
  financialGoals?: string[];
  existingInvestments?: string[];
}

export interface User {
  id: string;
  email: string;
  username: string;
  age?: number;
  gender?: string;
  income?: string;
  employmentStatus?: string;
  taxRegime?: string;
  homeownerStatus?: string;
  children?: string;
  childrenAges?: string;
  parentsAge?: string;
  investmentCapacity?: string;
  riskAppetite?: string;
  financialGoals?: string[];
  existingInvestments?: string[];
  createdAt?: string;
  lastLogin?: string;
}

export interface ChatSession {
  id: string;
  userId: string;
  title: string;
  createdAt: string;
  updatedAt: string;
  isActive: boolean;
  messageCount: number;
}

export interface ChatMessage {
  id: string;
  sessionId: string;
  role: 'user' | 'assistant';
  content: string;
  sources?: string[];
  responseTime?: number;
  cached?: boolean;
  createdAt: string;
}

export interface SavedMessage {
  id: string;
  userId: string;
  messageId: string;
  content: string;
  note?: string;
  tags?: string[];
  savedAt: string;
}

export interface AnalyticsSummary {
  totalQueries: number;
  totalUploads: number;
  activeUsers: number;
  totalTaxSaved: number;
  avgResponseTime: number;
  cacheHitRate: number;
  topEvents: { type: string; count: number }[];
  period?: string;
}

export interface ChatHistoryMessage {
  role: 'user' | 'assistant';
  content: string;
}

export interface UploadResponse {
  status: string;
  message: string;
}

export interface StatusResponse {
  initialized: boolean;
  documents_indexed: number;
  model: string | null;
}

// ===========================
// Authentication APIs
// ===========================

export async function register(
  email: string,
  username: string,
  password: string
): Promise<{ status: string; user: User; message?: string }> {
  const { data } = await api.post('/api/users/register', {
    email,
    username,
    password,
  });
  return data;
}

export async function login(
  email: string,
  password: string
): Promise<{ status: string; user: User; message?: string }> {
  const { data } = await api.post('/api/users/login', {
    email,
    password,
  });
  return data;
}

// ===========================
// Profile Management APIs
// ===========================

export async function getProfile(userId: string): Promise<User> {
  const { data } = await api.get(`/api/users/${userId}/profile`);
  return data;
}

export async function updateProfile(
  userId: string,
  profile: Partial<UserProfile>
): Promise<{ status: string;[key: string]: any }> {
  const { data } = await api.put(`/api/users/${userId}/profile`, profile);
  return data;
}

// ===========================
// Chat Session APIs
// ===========================

export async function createChatSession(
  userId: string,
  title?: string
): Promise<ChatSession> {
  const { data } = await api.post(`/api/users/${userId}/sessions`, { title });
  return data;
}

export async function getChatSessions(userId: string): Promise<ChatSession[]> {
  const { data } = await api.get(`/api/users/${userId}/sessions`);
  return data.sessions || [];
}

export async function getChatMessages(sessionId: string): Promise<ChatMessage[]> {
  const { data } = await api.get(`/api/sessions/${sessionId}/messages`);
  return data.messages || [];
}

export async function deleteChatSession(sessionId: string): Promise<{ status: string }> {
  const { data } = await api.delete(`/api/sessions/${sessionId}`);
  return data;
}

export async function updateChatSessionTitle(
  sessionId: string,
  title: string
): Promise<{ status: string; session: ChatSession }> {
  const { data } = await api.put(`/api/sessions/${sessionId}/title`, { title });
  return data;
}

// ===========================
// Saved Messages APIs
// ===========================

export async function saveMessage(
  userId: string,
  messageId: string,
  note?: string,
  tags?: string[]
): Promise<{ status: string; saved_message: SavedMessage }> {
  const { data } = await api.post(`/api/users/${userId}/saved-messages`, {
    message_id: messageId,
    note,
    tags,
  });
  return data;
}

export async function getSavedMessages(userId: string): Promise<SavedMessage[]> {
  const { data } = await api.get(`/api/users/${userId}/saved-messages`);
  return data;
}

// ===========================
// Analytics APIs
// ===========================

export async function getAnalyticsSummary(days: number = 30): Promise<AnalyticsSummary> {
  const { data } = await api.get(`/api/analytics/summary`, {
    params: { days },
  });
  return data;
}

export async function getQueryDistribution(
  days: number = 30
): Promise<{ date: string; count: number }[]> {
  const { data } = await api.get(`/api/analytics/query-distribution`, {
    params: { days },
  });
  return data;
}

// ===========================
// Document Management APIs
// ===========================

export async function getUserDocuments(userId: string) {
  const { data } = await api.get(`/api/users/${userId}/documents`);
  return data;
}

// ===========================
// Chat APIs (Updated)
// ===========================

export async function sendMessage(
  message: string,
  profile?: UserProfile,
  history?: ChatHistoryMessage[],
  userId?: string,
  sessionId?: string
): Promise<ChatResponse> {
  const { data } = await api.post<ChatResponse>('/api/chat', {
    message,
    profile,
    history,
    userId,
    sessionId,
  });

  // Handle response format (may have nested structure from Gemini)
  if (Array.isArray(data.response)) {
    // Extract text from Gemini's response format
    const textContent = data.response.find((item: any) => item.type === 'text');
    return {
      response: textContent?.text || 'No response',
      sources: data.sources,
    };
  }

  return data;
}

export async function sendMessageStream(
  message: string,
  profile: UserProfile | undefined,
  history: ChatHistoryMessage[],
  onToken: (token: string) => void,
  onSources: (sources: string[]) => void,
  userId?: string,
  sessionId?: string
): Promise<void> {
  try {
    const response = await fetch(`${API_BASE_URL}/api/chat/stream`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        message,
        profile,
        history,
        userId,
        sessionId,
      }),
    });

    if (!response.ok || !response.body) {
      throw new Error(`Streaming failed with status ${response.status}`);
    }

    const reader = response.body.getReader();
    const decoder = new TextDecoder('utf-8');
    let buffer = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const parts = buffer.split('\n\n');
      buffer = parts.pop() || '';

      for (const part of parts) {
        const lines = part.split('\n');
        let event = 'message';
        let data = '';

        for (const line of lines) {
          if (line.startsWith('event:')) {
            event = line.replace('event:', '').trim();
          } else if (line.startsWith('data:')) {
            data += line.replace('data:', '').trim();
          }
        }

        if (!data) continue;

        if (event === 'token') {
          onToken(JSON.parse(data));
        } else if (event === 'sources') {
          onSources(JSON.parse(data));
        } else if (event === 'error') {
          throw new Error(JSON.parse(data));
        } else if (event === 'done') {
          return;
        }
      }
    }
  } catch (error) {
    const fallback = await sendMessage(message, profile, history);
    onToken(fallback.response);
    onSources(fallback.sources || []);
  }
}

export async function uploadDocument(file: File, userId?: string): Promise<UploadResponse> {
  const formData = new FormData();
  formData.append('file', file);
  if (userId) {
    formData.append('userId', userId);
  }

  // Create a separate axios instance for FormData without default headers
  const uploadApi = axios.create({
    baseURL: API_BASE_URL,
  });

  uploadApi.interceptors.response.use(
    response => response,
    error => {
      console.error('Upload Error Details:', {
        message: error.message,
        code: error.code,
        baseURL: error.config?.baseURL,
        url: error.config?.url,
        status: error.response?.status,
        data: error.response?.data,
      });
      return Promise.reject(error);
    }
  );

  const { data } = await uploadApi.post<UploadResponse>('/api/upload', formData);

  return data;
}

export async function getStatus(): Promise<StatusResponse> {
  const { data } = await api.get<StatusResponse>('/api/status');
  return data;
}

export async function healthCheck(): Promise<boolean> {
  try {
    const { data } = await api.get('/ping');
    return data.status === 'ok';
  } catch {
    return false;
  }
}

export default api;
